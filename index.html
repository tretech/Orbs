<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbs System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        /* ... your existing CSS ... */
    </style>
</head>
<body>
    <script type="module">
        // Import Firebase modules here, as admin.js and explorer.js will now be modules.
        // This ensures Firebase is initialized before other modules that use it.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, addDoc, getDocs, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Import your local modules
        import { initAdmin } from './js/admin.js';
        import { initExplorer } from './js/explorer.js';

        // Your Firebase configuration (REPLACE WITH YOUR ACTUAL CONFIG)
        const firebaseConfig = {
            apiKey: "AIzaSyCYiaAH3wRzW6557xLJQ6zm9-RuSKBWWuM",
            authDomain: "orbdefine.firebaseapp.com",
            projectId: "orbdefine",
            storageBucket: "orbdefine.firebasestorage.app",
            messagingSenderId: "247935667317",
            appId: "1:247935667317:web:2dff8b9b44848553fafc3c",
            measurementId: "G-0VGTHSL2VZ"
        };
        const appId = "1:247935667317:web:2dff8b9b44848553fafc3c"; // Ensure this matches your Firestore collection structure

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Your custom confirmation modal (re-define or import if it's in a separate module)
        async function showConfirmModal(message) {
            return new Promise(resolve => {
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 modal-overlay';
                modalOverlay.innerHTML = `
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full modal-content">
                        <p class="text-white text-lg mb-4">${message}</p>
                        <div class="flex justify-end space-x-4">
                            <button id="cancel-confirm-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white font-semibold">Cancel</button>
                            <button id="ok-confirm-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white font-semibold">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modalOverlay);

                document.getElementById('ok-confirm-btn').onclick = () => {
                    modalOverlay.remove();
                    resolve(true);
                };
                document.getElementById('cancel-confirm-btn').onclick = () => {
                    modalOverlay.remove();
                    resolve(false);
                };
            });
        }

        // Authentication and module initialization
        let currentUserId = 'anonymous'; // Default or anonymous user ID
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("Firebase initialized and user signed in:", currentUserId);
            } else {
                // If no user, sign in anonymously or handle as needed
                console.log("No user signed in. Attempting anonymous sign-in.");
                try {
                    await signInAnonymously(auth);
                    // onAuthStateChanged will be called again with the anonymous user
                } catch (error) {
                    console.error("Error during anonymous sign-in:", error);
                }
            }
            // Once authentication state is known, initialize modules
            // Pass all Firebase functions needed for modular approach
            initAdmin(db, auth, appId, currentUserId, serverTimestamp, Papa, showConfirmModal, collection, query, where, addDoc, getDocs, doc, updateDoc, deleteDoc);
            initExplorer(db, appId, collection, query, getDocs);

            // Tab switching logic (already in your file)
            const explorerTab = document.getElementById('explorer-tab');
            const adminTab = document.getElementById('admin-tab');
            const explorerSection = document.getElementById('explorer-section');
            const adminSection = document.getElementById('admin-section');

            explorerTab.addEventListener('click', () => {
                explorerSection.classList.remove('hidden');
                explorerTab.classList.add('active');
                adminSection.classList.add('hidden');
                adminTab.classList.remove('active');
            });

            adminTab.addEventListener('click', () => {
                adminSection.classList.remove('hidden');
                adminTab.classList.add('active');
                explorerSection.classList.add('hidden');
                explorerTab.classList.remove('active');
            });

            // Ensure initial active tab is set correctly
            explorerTab.click(); // Default to explorer mode on load
        });
    </script>
</body>
</html>
